<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Factura</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form_factura.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loading_animation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/success_toast.css') }}">
</head>
<body>
    <div class="container">
        <h1>Registro de Factura (OCR + Datos)</h1>
        
        <!-- Indicador de progreso -->
        <div class="progress-indicator">
            <div class="progress-step active">
                <div class="step-icon">1</div>
                <div class="step-label">Cargar Factura</div>
            </div>
            <div class="progress-step">
                <div class="step-icon">2</div>
                <div class="step-label">Completar Datos</div>
            </div>
            <div class="progress-step">
                <div class="step-icon">3</div>
                <div class="step-label">Distribuir Cuentas</div>
            </div>
            <div class="progress-step">
                <div class="step-icon">4</div>
                <div class="step-label">Revisar y Enviar</div>
            </div>
        </div>
        
        <form action="{{ url_for('nueva_factura') }}" method="POST" enctype="multipart/form-data" id="facturaForm">
            <!-- Contenedor de pestañas mejorado -->
            <div class="tabs">
                <div class="tab-buttons">
                    <button type="button" class="tab-button active" data-tab="main">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <span class="tab-text">Datos Principales</span>
                    </button>
                    <button type="button" class="tab-button" data-tab="accounts">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <span class="tab-text">Detalle Cuentas</span>
                    </button>
                </div>

                <!-- Pestaña 1: Datos Principales -->
                <div class="tab-content active animate-fade-in" id="main">
                    <!-- Vista previa para OCR -->
                    <div class="image-preview-container" id="ocrPreviewContainer">
                        <img id="ocrImagePreview" class="image-preview" 
                             src="{% if form_saved_file_ocr %}{{ url_for('static', filename='uploads/' + form_saved_file_ocr) }}{% else %}#{% endif %}" 
                             style="{% if not form_saved_file_ocr %}display: none;{% endif %}">
                        <div class="image-preview-placeholder" id="ocrPlaceholder" 
                             style="{% if form_saved_file_ocr %}display: none;{% endif %}">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <span>Vista previa de la imagen (OCR)</span>
                        </div>
                        <div class="image-preview-badge">OCR</div>
                        <div id="ocrLoadingSpinner" class="loading-spinner" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    
                    <!-- Foto Voucher (OCR) -->
                    <div class="form-group card animate-slide-up">
                        <label for="foto_voucher_ocr">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                            Foto Voucher (OCR)
                        </label>
                        <div class="button-group">
                            <button type="button" class="btn-secondary btn-icon" onclick="document.getElementById('fileCameraOcr').click()">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                    <circle cx="12" cy="13" r="4"></circle>
                                </svg>
                                Tomar foto
                            </button>
                            <button type="button" class="btn-secondary btn-icon" onclick="document.getElementById('fileGalleryOcr').click()">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                Seleccionar de galería
                            </button>
                        </div>
                        <input 
                            type="file"
                            id="fileCameraOcr"
                            name="foto_voucher_camera_ocr"
                            accept="image/jpeg,image/png"
                            capture="camera"
                            style="display: none;"
                        >
                        <input 
                            type="file"
                            id="fileGalleryOcr"
                            name="foto_voucher_gallery_ocr"
                            accept="image/jpeg,image/png"
                            style="display: none;"
                        >
                    </div>

                    <!-- Campo oculto para conservar el nombre del archivo OCR -->
                    <input type="hidden" name="saved_file_ocr" value="{{ form_saved_file_ocr }}">

                    <!-- Botón para cargar datos (OCR) -->
                    <div class="mb-4">
                        <button 
                            type="submit"
                            name="action"
                            value="cargar"
                            class="btn-primary btn-icon"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            CARGAR DATOS
                        </button>
                    </div>

                    <!-- Cliente -->
                    <div class="form-group" style="position: relative; display: none;">
                        <label for="cliente_name">Cliente</label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <input
                                type="text"
                                id="cliente_name"
                                name="cliente_name"
                                class="form-control"
                                placeholder="Escriba el nombre del cliente"
                                autocomplete="off"
                            >
                        </div>
                        <input
                            type="hidden"
                            id="cliente_id"
                            name="cliente_id"
                            value="{{ form_cliente_id }}"
                        >
                        <div id="cliente_suggestions" class="autocomplete-suggestions"></div>
                        <div id="cliente_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- Tarjeta Titular -->
                    <div class="form-group" style="position: relative;">
                        <label for="tarjeta_name">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Tarjeta de Crédito Titular <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            <input
                                type="text"
                                id="tarjeta_name"
                                name="tarjeta_name"
                                class="form-control required"
                                placeholder="Escriba el nombre de la tarjeta titular"
                                autocomplete="off"
                            >
                        </div>
                        <input
                            type="hidden"
                            id="tarjeta_id"
                            name="tarjeta_id"
                            value="{{ form_tarjeta_id }}"
                            class="required"
                        >
                        <div id="tarjeta_suggestions" class="autocomplete-suggestions"></div>
                        <div id="tarjeta_name_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- Tarjeta Adicional -->
                    <div class="form-group" style="position: relative;">
                        <label for="tarjeta_adicional_name">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Tarjeta de Crédito Adicional
                        </label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            <input
                                type="text"
                                id="tarjeta_adicional_name"
                                name="tarjeta_adicional_name"
                                class="form-control"
                                placeholder="Escriba el nombre de la tarjeta adicional"
                                autocomplete="off"
                            >
                        </div>
                        <input
                            type="hidden"
                            id="tarjeta_adicional"
                            name="tarjeta_adicional"
                            value="{{ form_tarjeta_adicional }}"
                        >
                        <div id="tarjeta_adicional_suggestions" class="autocomplete-suggestions"></div>
                        <div id="tarjeta_adicional_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- Medio de compra -->
                    <div class="form-group" style="position: relative;">
                        <label for="medio_compra_name">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                            Medio de compra <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                            <input
                                type="text"
                                id="medio_compra_name"
                                name="medio_compra_name"
                                class="form-control required"
                                placeholder="Escriba el medio de compra"
                                autocomplete="off"
                            >
                        </div>
                        <input
                            type="hidden"
                            id="medio_compra"
                            name="medio_compra"
                            value="{{ form_medio_compra }}"
                            class="required"
                        >
                        <div id="medio_compra_suggestions" class="autocomplete-suggestions"></div>
                        <div id="medio_compra_name_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- País -->
                    <div class="form-group" style="position: relative;">
                        <label for="pais_name">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            País <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            <input
                                type="text"
                                id="pais_name"
                                name="pais_name"
                                value="{{ form_pais_nombre }}"
                                class="form-control required"
                                placeholder="Escriba el nombre del país"
                                autocomplete="off"
                            >
                        </div>
                        <input
                            type="hidden"
                            id="pais"
                            name="pais"
                            value="{{ form_pais }}"
                            class="required"
                        >
                        <div id="pais_suggestions" class="autocomplete-suggestions"></div>
                        <div id="pais_name_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- Ciudad -->
                    <div class="form-group" style="position: relative;">
                        <label for="ciudad_name">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            Ciudad <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <input
                                type="text"
                                id="ciudad_name"
                                name="ciudad_name"
                                value="{{ form_ciudad_nombre }}"
                                class="form-control required"
                                placeholder="Escriba el nombre de la ciudad"
                                autocomplete="off"
                            >
                        </div>
                        <input
                            type="hidden"
                            id="ciudad"
                            name="ciudad"
                            value="{{ form_ciudad }}"
                            class="required"
                        >
                        <div id="ciudad_suggestions" class="autocomplete-suggestions"></div>
                        <div id="ciudad_name_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- Moneda -->
                    <div class="form-group" style="position: relative;">
                        <label for="moneda_name">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="6" x2="12" y2="12"></line>
                                <line x1="12" y1="18" x2="12" y2="18"></line>
                            </svg>
                            Moneda <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="6" x2="12" y2="12"></line>
                                <line x1="12" y1="18" x2="12" y2="18"></line>
                            </svg>
                            <input
                                type="text"
                                id="moneda_name"
                                name="moneda_name"
                                value="{{ form_moneda_nombre }}"
                                class="form-control required"
                                placeholder="Escriba el nombre de la moneda"
                                autocomplete="off"
                            >
                        </div>
                        <input
                            type="hidden"
                            id="moneda"
                            name="moneda"
                            value="{{ form_moneda }}"
                            class="required"
                        >
                        <div id="moneda_suggestions" class="autocomplete-suggestions"></div>
                        <div id="moneda_name_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- Proveedor -->
                    <div class="form-group" style="position: relative;">
                        <label for="proveedor_name">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                            Proveedor <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                            <input
                                type="text"
                                id="proveedor_name"
                                name="proveedor_name"
                                class="form-control required"
                                placeholder="Escriba el nombre del proveedor"
                                autocomplete="off"
                            >
                        </div>
                        <input
                            type="hidden"
                            id="proveedor_id"
                            name="proveedor_id"
                            value="{{ form_proveedor_id }}"
                            class="required"
                        >
                        <div id="proveedor_suggestions" class="autocomplete-suggestions"></div>
                        <div id="proveedor_name_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- Fecha y Hora -->
                    <div class="form-group">
                        <label for="fecha_hora">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Fecha y Hora <span class="required">*</span>
                        </label>
                        <div class="d-flex gap-2">
                            <input 
                                type="datetime-local"
                                id="fecha_hora"
                                name="fecha_hora"
                                value="{{ form_fecha_hora }}"
                                class="form-control required"
                            >
                            <button type="button" id="setNowButton" class="btn-secondary btn-sm">Ahora</button>
                        </div>
                        <div id="fecha_hora_error" class="error-message text-danger" style="display: none;"></div>
                    </div>

                    <!-- Monto de la compra -->
                    <div class="form-group">
                        <label for="monto">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Monto de la compra <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5
